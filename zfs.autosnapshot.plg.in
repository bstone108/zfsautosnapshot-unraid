<?xml version='1.0' standalone='yes'?>
<PLUGIN name="zfs.autosnapshot" author="Brandon Stone" version="__VERSION__" icon="zfs-autosnapshot.png" pluginURL="__BASE_URL__/zfs.autosnapshot.plg" Launch="Settings/ZFSAutoSnapshot">
  <CHANGES>
### __VERSION__ (__BUILD_DATE__)
- Fixed delete-error handling so internal ZFS destroy failures now stop cleanly with clear user guidance.
- Added richer debug run diagnostics: plugin/Unraid/ZFS versions, kernel/host/user info, and pool overview.
- Changed log downloads to export both logs together (Debug + Latest Run Summary) in one text file.
- Added a delete watchdog: if one snapshot deletion runs longer than 120 seconds, the run exits with clear guidance so the next schedule can retry.
- Testing branch experiment: log viewer now uses a live stream transport first, with automatic fallback to refresh mode if streaming fails.
- Fixed Run Now failures caused by missing CSRF token handling, including clearer session-expired guidance.
- Hardened config loading for the snapshot engine and scheduler by replacing shell sourcing with safe key/value parsing.
- Added stricter safety validation for prefix/config values, with plain-English failure guidance in the latest run summary.
- Improved lock cleanup reliability and low-space cleanup resilience when pool availability checks fail.
- Removed obsolete legacy settings-page log API code and improved log refresh change detection reliability.
- Added a "Run Now" button in settings for one-click manual execution.
- Added dual log mode in WebUI: concise latest-run summary by default, with a debug toggle for the verbose log.
- Added combined log download support in WebUI.
- Snapshot engine now writes a one-run summary file (`/var/log/zfs_autosnapshot.last.log`) with created/deleted totals by category.
- Fixed a low-space cleanup crash (`sort` broken pipe) that could stop a run early while deleting old snapshots.
- Installed Plugins page now uses the custom plugin icon instead of the generic icon.
- Boot reliability fix: cron schedule is now auto-synced on server startup/array mount via `event/disks_mounted`.
- Log retention improvement: each run writes a `[RUN_START]` marker and prunes the log to keep only the latest 2 runs.
- Disabled-schedule safeguard: install/upgrade now explicitly removes the plugin cron file when `SCHEDULE_MODE=disabled`.
- Install/upgrade now always refreshes cron runtime (`update_cron` + `crond` restart), so existing schedules activate without pressing Save.
- Scheduler reliability fix: every schedule apply/disable now refreshes cron runtime and restarts `crond`.
- Fixed macOS metadata pollution on fresh installs: build now disables AppleDouble archive metadata and post-install removes stray `._*` files.
- Hardened fresh-install behavior: installer now enforces package install success and verifies package registration in `/var/log/packages`.
- Added uninstall fallback cleanup for systems missing package DB entries from earlier installs.
- Moved the Save Settings button above the Live Run Log panel for quicker access.
- Fixed Live Run Log "Invalid JSON response" by moving log reads to a dedicated JSON endpoint (`/plugins/.../php/log-tail.php`).
- Removed the extra "View Live Log" button under Dry Run.
- Improved Live Run Log polling compatibility by using XHR transport.
- Added the installed plugin version badge at the top of the settings page for quick verification.
- Added a real-time log viewer in the WebUI so Dry Run output is visible live (including `[DRY_RUN]` actions).
- Updated the Prefix help text to show the actual configured prefix value and clearer wording.
- Installer now forces a cron sync immediately after package install so schedule changes apply without requiring a manual Save.
- Fixed generated cron entry format for Unraid/BusyBox (`/etc/cron.d`) by removing the unsupported username column.
- Adjusted Datasets card layout so the Dry Run checkbox sits on its own line under Snapshot prefix (prevents overlap).
- Added new schedule mode: run every N minutes (1-59), alongside existing hourly/daily/weekly/custom options.
- Improved dataset discovery to scan each pool individually and include both filesystems and zvols.
- Redesigned dataset picker with pool filter dropdown, cleaner grouping, and quick select controls.
- Fixed script execution format: install/remove `Run="/bin/bash"` blocks now use explicit `<INLINE><![CDATA[...]]></INLINE>`.
- Simplified WebUI registration to a single `Menu="Utilities"` page (same model as User Scripts).
- Fixed package download block to use explicit `&lt;URL&gt;` and `&lt;MD5&gt;` nodes required by current Unraid plugin installer.
- Added resilient installer fallback: plugin install script now downloads and MD5-verifies package directly before `upgradepkg`.
- Fixed install/remove script paths to use literal values (avoids unresolved XML entities in CDATA).
- Web UI for dataset checkbox selection and retention settings.
- Plain-English scheduling (minutes/hourly/daily/weekly/custom) with cron sync.
- Time-based and space-based cleanup plus fresh snapshot creation.
  </CHANGES>

  <FILE Name="/boot/config/plugins/zfs.autosnapshot/zfs-autosnapshot-__VERSION__-noarch-1.txz" Min="6.11.0">
    <URL>__BASE_URL__/zfs-autosnapshot-__VERSION__-noarch-1.txz</URL>
    <MD5>__PKG_MD5__</MD5>
  </FILE>

  <FILE Run="/bin/bash">
    <INLINE><![CDATA[
set -euo pipefail

PKG_DIR="/boot/config/plugins/zfs.autosnapshot"
PKG_FILE="zfs-autosnapshot-__VERSION__-noarch-1.txz"
PKG_PATH="${PKG_DIR}/${PKG_FILE}"
PKG_URL="__BASE_URL__/${PKG_FILE}"
PKG_MD5="__PKG_MD5__"
PKG_NAME="zfs-autosnapshot"

if command -v upgradepkg >/dev/null 2>&1; then
  UPGRADEPKG="$(command -v upgradepkg)"
elif [[ -x /sbin/upgradepkg ]]; then
  UPGRADEPKG="/sbin/upgradepkg"
elif [[ -x /usr/sbin/upgradepkg ]]; then
  UPGRADEPKG="/usr/sbin/upgradepkg"
else
  echo "ERROR: upgradepkg not found on system." >&2
  exit 1
fi

mkdir -p "${PKG_DIR}"

download_pkg() {
  if command -v wget >/dev/null 2>&1; then
    wget --no-cache -O "${PKG_PATH}" "${PKG_URL}"
  else
    curl -fsSL "${PKG_URL}" -o "${PKG_PATH}"
  fi
}

verify_md5() {
  if command -v md5sum >/dev/null 2>&1; then
    echo "${PKG_MD5}  ${PKG_PATH}" | md5sum -c -
  else
    [[ "$(md5 -q "${PKG_PATH}")" == "${PKG_MD5}" ]]
  fi
}

if [[ ! -f "${PKG_PATH}" ]]; then
  download_pkg
fi

if ! verify_md5; then
  rm -f "${PKG_PATH}"
  download_pkg
  verify_md5
fi

"${UPGRADEPKG}" --install-new "${PKG_PATH}"

if ! ls -1 /var/log/packages 2>/dev/null | grep -q "^${PKG_NAME}"; then
  echo "Package registration missing after install; retrying with --reinstall." >&2
  "${UPGRADEPKG}" --install-new --reinstall "${PKG_PATH}"
fi

if ! ls -1 /var/log/packages 2>/dev/null | grep -q "^${PKG_NAME}"; then
  echo "ERROR: ${PKG_NAME} is still missing from /var/log/packages after install." >&2
  exit 1
fi

if [ -x /usr/local/emhttp/plugins/zfs.autosnapshot/scripts/sync-cron.sh ]; then
  /usr/local/emhttp/plugins/zfs.autosnapshot/scripts/sync-cron.sh || true
fi
    ]]></INLINE>
  </FILE>

  <FILE Run="/bin/bash" Method="remove">
    <INLINE><![CDATA[
set -euo pipefail

if [ -x /usr/local/emhttp/plugins/zfs.autosnapshot/scripts/pre-remove.sh ]; then
  /usr/local/emhttp/plugins/zfs.autosnapshot/scripts/pre-remove.sh || true
fi

removepkg zfs-autosnapshot >/dev/null 2>&1 || true

# Fallback cleanup for installs that missed package DB registration.
rm -f /usr/local/sbin/zfs_autosnapshot
rm -rf /usr/local/emhttp/plugins/zfs.autosnapshot

rm -f /boot/config/plugins/zfs.autosnapshot/zfs-autosnapshot-*-noarch-1.txz
rm -f /boot/config/plugins/zfs.autosnapshot/zfs-autosnapshot-*-noarch-1.txz.md5
rmdir /boot/config/plugins/zfs.autosnapshot 2>/dev/null || true
    ]]></INLINE>
  </FILE>
</PLUGIN>
